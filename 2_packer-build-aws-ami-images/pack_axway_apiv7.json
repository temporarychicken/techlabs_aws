{
  "description": "Create an NGINX Plus and two NGINX Open Source Images",
  "variables": {
    "home": "{{env `HOME`}}",
    "aws_access_key": "",
    "aws_secret_key": "",
    "region": "eu-west-2"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "name": "techlab-axwayv7",
      "ami_name": "techlab-axwayv7-{{isotime \"2006-01-02\"}}-{{uuid}}",
      "instance_type": "t2.large",
      "region": "{{user `region`}}",
      "source_ami": "ami-006a0174c6c25ac06",
      "ssh_username": "ubuntu",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "tags": {
        "Name": "techlab-axwayv7"
      }
    }
  ],
  "provisioners": [

    {
      "type": "file",
      "source": "resources",
      "destination": "resources",
      "only": [
        "techlab-axwayv7"
      ]
    },

    {
      "type": "file",
      "source": "../certs",
      "destination": "certs",
      "only": [
        "techlab-axwayv7"
      ]
    },

    {
      "type": "shell",
      "inline": [
	  
	  "# SET HOSTNAME FOR OUR API MANAGER SERVER",
	  "sudo hostnamectl set-hostname apimanager",
	  
	  "#CONFIGURE THE SYSTEMD INIT SCRIPTS FOR AUTOMATIC START OF API MANAGER SERVICES",
	  "chmod +x resources/scripts/*",
	  "sudo cp resources/system/cassandra.service /etc/systemd/system",
	  "sudo systemctl enable cassandra",
	  "sudo cp resources/system/nodemanager.service /etc/systemd/system",
	  "sudo systemctl enable nodemanager",
	  "sudo cp resources/system/quickstart.service /etc/systemd/system",
	  "sudo systemctl enable quickstart",
	  "sudo cp resources/system/apibuilder.service /etc/systemd/system",
	  "sudo systemctl enable apibuilder",
	  
	  "#INSTALL NODE JS VERSION 14 (A pre-requisite for API Builder)",
      "curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -",
      "sudo apt-get remove nodejs -y",
      "sudo apt-get install nodejs -y",

	  "#INSTALL API BUILDER",
	  "sudo npm install -g @axway/amplify-cli",
      "amplify pm install @axway/amplify-api-builder-cli",
      "npm install @axway-api-builder-ext/api-builder-plugin-dc-postgres",
      "amplify builder init mybuilderproject",
	  "echo '##################################################'",
	  "echo 'CHANGE THE DEFAULT API BUILDER PORT NUMBER TO 8083'",
	  "echo '##################################################'",
	  "sed -i 's/ parseInt(process.env.PORT) || 8080/ 8083/g' mybuilderproject/conf/default.js",

	  
	  "#DOWLOAD AND INSTALL AXWAY API MANAGER INCLUDING PREREQUISITES",
	  "wget https://packer-build-resources.s3.eu-west-2.amazonaws.com/APIGateway_7.7.20210130_Install_linux-x86-64_BN04.run",
	  "chmod +x APIGateway_7.7.20210130_Install_linux-x86-64_BN04.run",
	  "sudo apt-get update -y",
	  "sudo apt-get install openjdk-8-jre-headless -y",
      "sudo ./APIGateway_7.7.20210130_Install_linux-x86-64_BN04.run --mode unattended --unattendedmodeui minimalWithDialogs --nmHostnameOrIpChoice 127.0.0.1 --rnmConnectionUrl https://127.0.0.1:8090 --setup_type complete --adminpasswd Space*117 --changeCredentials 0 --apimgmtusername apiadmin --apiadminpasswd Space*117 --changeApimgmtCredentials 0 --licenseFilePath resources/api7.lic --analyticsLicenseFilePath resources/api7.lic --apimgmtLicenseFilePath resources/api7.lic --prefix /opt/Axway-7.7.0 --cassandraInstalldir /opt --cassandraJDK  /usr/lib/jvm/java-8-openjdk-amd64/jre --startCassandra 0",

      "#INSTALL THE NGINX REVERSE PROXY TO ENABLE TLS TERMINATION AT THE FRONT-END",
      "sudo -H apt-get install -y nginx",

      "#DOWNLOAD THE SSH KEY TO ENABLE FUTURE ACCESS TO THIS SERVER",
	  "ssh-keygen -f /tmp/sshkey -q -N ''",
   	  "chmod +r /tmp/sshkey"
	  
      ],
      "only": [
        "techlab-axwayv7"
      ]
    },



   {
      "type": "file",
      "destination": "../keys/axwayv7-key.pub",
      "source": "/tmp/sshkey.pub",
	  "direction" : "download",
      "only": [
        "techlab-axwayv7"
      ]
    },
   {
      "type": "file",
      "destination": "../keys/axwayv7-key.pem",
      "source": "/tmp/sshkey",
	  "direction" : "download",
      "only": [
        "techlab-axwayv7"
      ]
    }
	
  ]
}




